<section class="panel">
  <h2>Vyhledávání v Novinách Metrostavu</h2>
  <p class="muted">Napiš dotaz a najdu relevantní články na noviny.metrostav.cz</p>

  <div style="display:flex; gap:10px; margin-top:12px;">
    <input id="q" type="search" placeholder="Např. tunel, Blanka, BOZP…" style="flex:1; padding:10px 12px; border-radius:10px;">
    <button id="btn" style="padding:10px 14px; border-radius:10px;">Hledat</button>
  </div>

  <div id="meta" class="muted" style="margin-top:10px;"></div>
  <div id="results" style="margin-top:14px;"></div>
</section>
<script>
  const $q = document.getElementById("q");
  const $btn = document.getElementById("btn");
  const $meta = document.getElementById("meta");
  const $results = document.getElementById("results");

  function escapeHtml(s) {
    return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  async function runSearch() {
    const q = ($q.value || "").trim();
    if (!q) {
      $meta.textContent = "";
      $results.innerHTML = "";
      return;
    }

    $meta.textContent = "Hledám…";
    $results.innerHTML = "";

    try {
      const res = await fetch(`/search?q=${encodeURIComponent(q)}&limit=20`, { cache: "no-store" });
      const data = await res.json();

      $meta.textContent = `Dotaz: "${data.q}" • Nalezeno: ${data.results.length}`;

      if (!data.results.length) {
        $results.innerHTML = `<div class="muted">Nic nenalezeno.</div>`;
        return;
      }

      $results.innerHTML = data.results.map(r => `
        <div style="padding:12px 0; border-bottom:1px solid rgba(255,255,255,.10);">
          <div style="font-weight:700; margin-bottom:4px;">
            <a href="${r.url}" target="_blank" rel="noopener" style="text-decoration:underline;">
              ${escapeHtml(r.title || r.url)}
            </a>
          </div>
          <div class="muted">${r.snippet || ""}</div>
        </div>
      `).join("");

    } catch (e) {
      $meta.textContent = "";
      $results.innerHTML = `<div class="muted">Chyba vyhledávání (zkus to za chvíli).</div>`;
    }
  }

  $btn.addEventListener("click", runSearch);
  $q.addEventListener("keydown", (e) => {
    if (e.key === "Enter") runSearch();
  });

  // pokud přijde q v URL: /?q=tunel
  const params = new URL(location.href).searchParams;
  const preset = params.get("q");
  if (preset) {
    $q.value = preset;
    runSearch();
  }
</script>
